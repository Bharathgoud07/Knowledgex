{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">My Activity Dashboard</h3>

  <!-- Summary cards -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <p class="text-muted mb-1">Uploads</p>
          <h3 class="mb-0 fw-bold">{{ uploads_count }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <p class="text-muted mb-1">Favorites Saved</p>
          <h3 class="mb-0 fw-bold">{{ favorites_count }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <p class="text-muted mb-1">Ratings Received</p>
          <h3 class="mb-0 fw-bold">{{ ratings_received }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <p class="text-muted mb-1">Views / Downloads</p>
          <h4 class="mb-0 fw-bold">{{ total_views }} / {{ total_downloads }}</h4>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Views & Downloads per your upload</h5>
      <canvas id="activityChart" height="110"></canvas>
    </div>
  </div>

  <!-- Table with each upload -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="card-title mb-3">Your uploads (detailed)</h5>

      {% if my_uploads %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Title</th>
                <th>Subject</th>
                <th>Type</th>
                <th class="text-center">Views</th>
                <th class="text-center">Downloads</th>
                <th class="text-center">Rating</th>
                <th>Uploaded</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for res in my_uploads %}
                <tr>
                  <td>
                    <a href="{% url 'resource_detail' res.pk %}">
                      {{ res.title }}
                    </a>
                  </td>
                  <td>
                    {% if res.subject %}{{ res.subject }}{% else %}N/A{% endif %}
                  </td>
                  <td>
                    {% for val,label in resource_type_choices %}
                      {% if val == res.resource_type %}{{ label }}{% endif %}
                    {% endfor %}
                  </td>
                  <td class="text-center">{{ res.view_count }}</td>
                  <td class="text-center">{{ res.download_count }}</td>
                  <td class="text-center">
                    {% if res.rating_count %}
                      {{ res.average_rating }}/5 ({{ res.rating_count }})
                    {% else %}
                      –
                    {% endif %}
                  </td>
                  <td>{{ res.created_at|date:"M d, Y H:i" }}</td>
                  <td>
                    {% if res.verification_status == "APPROVED" %}
                      <span class="badge bg-success">Verified</span>
                    {% elif res.verification_status == "REJECTED" %}
                      <span class="badge bg-danger">Rejected</span>
                    {% else %}
                      <span class="badge bg-secondary">Pending</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">You haven’t uploaded anything yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = JSON.parse('{{ labels_json|escapejs }}');
  const viewsData = JSON.parse('{{ views_json|escapejs }}');
  const downloadsData = JSON.parse('{{ downloads_json|escapejs }}');

  const ctx = document.getElementById('activityChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Views',
          data: viewsData,
          borderWidth: 1
        },
        {
          label: 'Downloads',
          data: downloadsData,
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
</script>
{% endblock %}
